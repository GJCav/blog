
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://blog.gjm20.top/Linux/KVM-Virtualization/networking/">
      
      
        <link rel="prev" href="../remote-management/">
      
      
        <link rel="next" href="../win-perf/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.4">
    
    
      
        <title>虚拟机网络配置 - Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.50c56a3b.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/heimu.css">
    
      <link rel="stylesheet" href="../../../css/img.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-CN7E4ZDLFQ"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-CN7E4ZDLFQ",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-CN7E4ZDLFQ",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>var consent;"undefined"==typeof __md_analytics||(consent=__md_get("__consent"))&&consent.analytics&&__md_analytics()</script>
  

    
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Blog" class="md-header__button md-logo" aria-label="Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              虚拟机网络配置
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="deep-orange" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/GJCav/blog/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Blog" class="md-nav__button md-logo" aria-label="Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/GJCav/blog/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    建站
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            建站
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../build-a-website/DDNS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DDNS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../build-a-website/%E9%81%BF%E5%85%8D%E7%AC%94%E8%AE%B0%E6%9C%AC%E4%BC%91%E7%9C%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    阻止笔记本休眠
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Win 奇技淫巧
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Win 奇技淫巧
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../win-tricks/Hyper-v%20%E6%97%A0%E6%B3%95%E6%B7%BB%E5%8A%A0%E5%A4%96%E9%83%A8%E4%BA%A4%E6%8D%A2%E6%9C%BA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hyper-v 添加外部交换机问题
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../win-tricks/auto-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    win 配置开机自启动
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../win-tricks/baiduyun-starter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    限制百度云 CPU 占用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../win-tricks/pwsh-snippet/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Powershell Snippet
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../win-tricks/run-silently/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    无窗口运行某程序
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../win-tricks/win-%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    win-计划任务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../win-tricks/%E4%BD%BF%E7%94%A8rclone%E6%8C%82%E8%BD%BD%E7%A1%AC%E7%9B%98/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Win 使用 Rclone 挂载硬盘
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../win-tricks/%E5%BA%94%E7%94%A8%E6%8E%A8%E8%8D%90/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    应用推荐
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Python
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/conda-%E6%8E%A8%E8%8D%90%E9%85%8D%E7%BD%AE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    conda 推荐配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/pytest-cov-%E4%BD%BF%E7%94%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pytest-cov 代码覆盖率测试
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/python-%E6%9C%80%E5%B0%8F%E5%8C%96%E6%89%93%E5%8C%85/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    最小化打包 非pyinstaller
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../python/%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83%E6%AF%94%E8%BE%83/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python 虚拟环境管理方案比较
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Linux
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Linux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../N%E6%8C%81%E4%B9%85%E6%A8%A1%E5%BC%8F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    N 卡开启持久模式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../waydroid-%E6%8A%98%E8%85%BE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Waydroid 折腾
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_3" >
        
          
          <label class="md-nav__link" for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    指令速查
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            指令速查
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tldr/alias/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    alias 别名
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tldr/lsof%20%E6%8C%87%E5%8C%97/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lsof 指北
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tldr/screen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    screen 速查
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_4" >
        
          
          <label class="md-nav__link" for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    代码片段
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            代码片段
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../snippet/Proxy-Toggle/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Proxy-Toggle
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../snippet/ln-all/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ln-all 创建软连接
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../snippet/ln-mv/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ln-mv 移动软连接
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    KVM-Virtualization
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            KVM-Virtualization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../qemu-kvm-ecosystem/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    QEMU-KVM-libvirt 生态与安装
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hardware-details/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    虚拟硬件入门
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli-management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    命令行管理虚拟机
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../remote-management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    远程管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    虚拟机网络配置
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    虚拟机网络配置
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#virtual-network-switches" class="md-nav__link">
    <span class="md-ellipsis">
      Virtual Network Switches
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nat" class="md-nav__link">
    <span class="md-ellipsis">
      NAT 模式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NAT 模式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      基本使用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#guest-internet" class="md-nav__link">
    <span class="md-ellipsis">
      使 Guest 可从 Internet 访问
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ipv6" class="md-nav__link">
    <span class="md-ellipsis">
      启用 IPv6
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ipv6-nat" class="md-nav__link">
    <span class="md-ellipsis">
      启用 IPv6 NAT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ipv6-dnat" class="md-nav__link">
    <span class="md-ellipsis">
      配置 IPv6 DNAT
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      其他内容
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../win-perf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Win on KVM 性能测试
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Network
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Network
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../network/%E5%B0%8F%E7%B1%B3%E8%B7%AF%E7%94%B1%E5%99%A8AX6S%E6%8A%98%E8%85%BE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    小米路由器 AX6S 折腾
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    实验室
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            实验室
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog-lab/meta%E6%A8%A1%E6%9D%BF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meta 模板
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog-lab/%E5%9B%BE%E5%83%8F%E6%A0%B7%E5%BC%8F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    图像样式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog-lab/%E9%BB%91%E5%B9%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    黑幕
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tag-index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tag Index
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../LICENSE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LICENSE
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#virtual-network-switches" class="md-nav__link">
    <span class="md-ellipsis">
      Virtual Network Switches
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nat" class="md-nav__link">
    <span class="md-ellipsis">
      NAT 模式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="NAT 模式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      基本使用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#guest-internet" class="md-nav__link">
    <span class="md-ellipsis">
      使 Guest 可从 Internet 访问
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ipv6" class="md-nav__link">
    <span class="md-ellipsis">
      启用 IPv6
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ipv6-nat" class="md-nav__link">
    <span class="md-ellipsis">
      启用 IPv6 NAT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ipv6-dnat" class="md-nav__link">
    <span class="md-ellipsis">
      配置 IPv6 DNAT
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      其他内容
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  <!-- Determine whether to show tags -->


<!-- Tags -->
<nav class="md-tags"  style="font-size: small">

  <style>
    .md-tags > .twemoji ~ .twemoji {
      margin-left: 0.4rem;
    }
  </style>

  <!-- create time -->
  
  <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5v-5Z"></path></svg></span>
  <span>2024-03-25</span>
  

  
  <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"></path></svg></span>
  <span>2024-03-27</span>
  
  
  <!-- tags -->
  
    <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="m345 39.1 127.8 129.3c52.4 53 52.4 138.2 0 191.2l-112 113.3c-9.3 9.4-24.5 9.5-33.9.2s-9.5-24.5-.2-33.9l111.9-113.3c33.9-34.3 33.9-89.4 0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6.2-33.9s24.6-9.2 33.9.2zM0 229.5V80c0-26.5 21.5-48 48-48h149.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5 0 90.5L277.3 442.7c-25 25-65.5 25-90.5 0l-168-168C6.7 262.7 0 246.5 0 229.5zM144 144a32 32 0 1 0-64 0 32 32 0 1 0 64 0z"></path></svg></span>
    
      

      <!-- Render tag with link -->
      
        <a href="../../../tag-index/#linux" class="md-tag">Linux</a>

      <!-- Render tag without link -->
      
    
      

      <!-- Render tag with link -->
      
        <a href="../../../tag-index/#kvm" class="md-tag">KVM</a>

      <!-- Render tag without link -->
      
    
      

      <!-- Render tag with link -->
      
        <a href="../../../tag-index/#vm" class="md-tag">VM</a>

      <!-- Render tag without link -->
      
    
      

      <!-- Render tag with link -->
      
        <a href="../../../tag-index/#network" class="md-tag">Network</a>

      <!-- Render tag without link -->
      
    
  
</nav>


  
  


<h1 id="_1">虚拟机网络配置</h1>
<p>虚拟网络结构、功能需按照需求配置，典型例子：</p>
<ul>
<li>NAT 模式：为 guests 局域网分配局域网 IP<ul>
<li>Guest -&gt; Internet：使用 NAT 技术依托 host 的网络连接互联网</li>
<li>Guest &lt;- Internet：需额外在 host 上配置端口转发</li>
<li>Guest &lt;-&gt; Guest：可访问</li>
<li>Guest --&gt; Host：可访问</li>
<li>Guest &lt;-- Host：可访问</li>
</ul>
</li>
<li>隔离模式：为 guests 单独搭建一套网络<ul>
<li>Guest -&gt; Internet：无</li>
<li>Guest &lt;-&gt; Guest：可访问</li>
<li>Guest 与 Host：无法相互访问</li>
</ul>
</li>
<li>共享网卡：相当于使用交换机连接 guest 和 host 的一个网口<ul>
<li>Guest -&gt; Internet：需要 guest 自行通过宽带拨号/DHCP等手段获取 IP</li>
</ul>
</li>
<li>网卡直通</li>
<li>路由模式</li>
</ul>
<!-- more -->

<p>参考资料：</p>
<ul>
<li><a href="https://wiki.libvirt.org/VirtualNetworking.html">libvirt: Virtual Networking</a></li>
<li><a href="https://wiki.libvirt.org/Networking.html">libvirt: Networking</a></li>
<li><a href="https://libvirt.org/formatnetwork.html">libvirt: Network XML format</a></li>
<li><a href="https://en.wikipedia.org/wiki/IPv6_address">IPv6 address - Wikipedia</a></li>
<li><a href="https://en.wikipedia.org/wiki/Unique_local_address">Unique local address - Wikipedia</a></li>
<li><a href="https://www.rfcreader.com/#rfc3484">RFC3484  Default Address Selection for IPv6</a></li>
</ul>
<p>此外，本文使用大量从 <a href="https://wiki.libvirt.org/VirtualNetworking.html">libvirt: Virtual Networking</a> 下载的图片。</p>
<h2 id="virtual-network-switches">Virtual Network Switches</h2>
<p>libvirt 使用名为 virtual network switch (VNS)的虚拟器件提供虚拟网络。如果读者熟悉 OSI 模型，多半下意识认为这个 “switch” 对应链路层，功能应该与一个交换机类似。但此 switch 非彼 switch，取决于具体网络配置，virtual network switch 可能工作在链路层，也可能工作在网络层。</p>
<p>Libvirt 将 Virtual Network Switches 表示成这个样子：</p>
<p><a class="glightbox" href="../typora/Linux_host_with_only_a_virtual_network_switch.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="images/Linux_host_with_only_a_virtual_network_switch.png" src="../typora/Linux_host_with_only_a_virtual_network_switch.png" /></a></p>
<p>虽然名字中带着个 "switch"，但他的设备名却显示为 “virbr0”，其中的“br” 暗示着是一个网桥。更让人迷惑的是，VNS 可以实现 NAT，一种通常是路由器才会提供的功能，所以 VNS 多多少少也能理解成一个路由器。</p>
<p>严格来说，switch、bridge、router 应该是不同的东西，VNS 提供又能实现这三种设备的功能，所以最好忽略这些文绉绉的名词定义，不要过多纠结。</p>
<h2 id="nat">NAT 模式</h2>
<h3 id="_2">基本使用</h3>
<p>NAT 模式是 libvirt 的默认网络模式，VNS：</p>
<ul>
<li>为虚拟机分配局域网 IPv4 地址</li>
<li>对 guest 发往 Internet 的数据包实施 SNAT，为 guest 提供网络访问</li>
<li>默认阻拦 Internet 到 guest 的数据包，除非它属于从一个从 guest 发起的连接</li>
<li>允许 guest 间、guest &lt;--&gt; host 的相互访问</li>
</ul>
<p>网络结构图：</p>
<p><a class="glightbox" href="../typora/Host_with_a_virtual_network_switch_in_nat_mode_and_two_guests.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="images/Host_with_a_virtual_network_switch_in_nat_mode_and_two_guests.png" src="../typora/Host_with_a_virtual_network_switch_in_nat_mode_and_two_guests.png" /></a></p>
<p>典型配置文件例：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nt">&lt;network&gt;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">  </span><span class="nt">&lt;name&gt;</span>net_name<span class="nt">&lt;/name&gt;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">  </span><span class="nt">&lt;uuid&gt;</span>UUID<span class="nt">&lt;/uuid&gt;</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="nt">&lt;forward</span><span class="w"> </span><span class="na">mode=</span><span class="s">&#39;nat&#39;</span><span class="w"> </span><span class="nt">/&gt;</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">  </span><span class="nt">&lt;bridge</span><span class="w"> </span><span class="na">name=</span><span class="s">&#39;virbr0&#39;</span><span class="w"> </span><span class="na">stp=</span><span class="s">&#39;on&#39;</span><span class="w"> </span><span class="na">delay=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">  </span><span class="nt">&lt;mac</span><span class="w"> </span><span class="na">address=</span><span class="s">&#39;52:54:00:4e:3c:17&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">  </span><span class="nt">&lt;ip</span><span class="w"> </span><span class="na">address=</span><span class="s">&#39;192.168.122.1&#39;</span><span class="w"> </span><span class="na">netmask=</span><span class="s">&#39;255.255.255.0&#39;</span><span class="nt">&gt;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">    </span><span class="nt">&lt;dhcp&gt;</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">      </span><span class="nt">&lt;range</span><span class="w"> </span><span class="na">start=</span><span class="s">&#39;192.168.122.2&#39;</span><span class="w"> </span><span class="na">end=</span><span class="s">&#39;192.168.122.254&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="nt">&lt;/dhcp&gt;</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">  </span><span class="nt">&lt;/ip&gt;</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="nt">&lt;/network&gt;</span>
</span></code></pre></div>
<h3 id="guest-internet">使 Guest 可从 Internet 访问</h3>
<p>NAT 模式下 guest 只有局域网 IP 地址，若希望从互联网直接访问 guest，需先将数据发送到具有公网 IP 地址的 host，host 再通过端口转发将数据转发到 guest。本质上是做了一个 DNAT。</p>
<p>配置流程：</p>
<ul>
<li>
<p>打开 Linux 的数据包转发，<code>sudo vim /etc/sysctl.conf</code>，添加一行：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>net.ipv4.ip_forward = 1
</span></code></pre></div>
<p>然后执行 <code>sysctl -p /etc/sysctl.conf</code> 应用更改</p>
</li>
<li>
<p>使用 <code>iptables</code> 配置 DNAT</p>
</li>
</ul>
<p>但 iptables 的配置复杂且易错，还是使用程序自动配置为好。<a href="https://wiki.libvirt.org/Networking.html#forwarding-incoming-connections">libvirt: forwarding incoming connections</a> 中提供了 3 种自动脚本，个人推荐这个 Python 项目：</p>
<ul>
<li><a href="https://github.com/saschpe/libvirt-hook-qemu">saschpe/libvirt-hook-qemu: Libvirt hook for setting up iptables port-forwarding rules when using NAT-ed networking</a></li>
</ul>
<p>该脚本将在虚拟机启动时自动启用 DNAP，在虚拟机关机时取消。比较好用</p>
<h3 id="ipv6">启用 IPv6</h3>
<p>libvirt 默认只为 guests 分配 IPv4 地址，如要为 guests 分配 IPv6 地址，需修改网络的 xml 配置为：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nt">&lt;network&gt;</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">  </span><span class="nt">&lt;name&gt;</span>net_name<span class="nt">&lt;/name&gt;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">  </span><span class="nt">&lt;uuid&gt;</span>UUID<span class="nt">&lt;/uuid&gt;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">  </span><span class="nt">&lt;forward</span><span class="w"> </span><span class="na">mode=</span><span class="s">&#39;nat&#39;</span><span class="w"> </span><span class="nt">/&gt;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">  </span><span class="nt">&lt;bridge</span><span class="w"> </span><span class="na">name=</span><span class="s">&#39;virbr0&#39;</span><span class="w"> </span><span class="na">stp=</span><span class="s">&#39;on&#39;</span><span class="w"> </span><span class="na">delay=</span><span class="s">&#39;0&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">  </span><span class="nt">&lt;mac</span><span class="w"> </span><span class="na">address=</span><span class="s">&#39;52:54:00:4e:3c:17&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">  </span><span class="nt">&lt;ip</span><span class="w"> </span><span class="na">address=</span><span class="s">&#39;192.168.122.1&#39;</span><span class="w"> </span><span class="na">netmask=</span><span class="s">&#39;255.255.255.0&#39;</span><span class="nt">&gt;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="nt">&lt;dhcp&gt;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">      </span><span class="nt">&lt;range</span><span class="w"> </span><span class="na">start=</span><span class="s">&#39;192.168.122.2&#39;</span><span class="w"> </span><span class="na">end=</span><span class="s">&#39;192.168.122.254&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="nt">&lt;/dhcp&gt;</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">  </span><span class="nt">&lt;/ip&gt;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">  </span><span class="nt">&lt;ip</span><span class="w"> </span><span class="na">family=</span><span class="s">&#39;ipv6&#39;</span><span class="w"> </span><span class="na">address=</span><span class="s">&#39;fdXX:XXXX:XXXX:NNNN::1&#39;</span><span class="w"> </span><span class="na">prefix=</span><span class="s">&#39;64&#39;</span><span class="nt">&gt;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span><span class="nt">&lt;dhcp&gt;</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">      </span><span class="nt">&lt;range</span><span class="w"> </span><span class="na">start=</span><span class="s">&#39;fdXX:XXXX:XXXX:NNNN::10&#39;</span><span class="w"> </span><span class="na">end=</span><span class="s">&#39;fdXX:XXXX:XXXX:NNNN::ff&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">    </span><span class="nt">&lt;/dhcp&gt;</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">  </span><span class="nt">&lt;/ip&gt;</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="nt">&lt;/network&gt;</span>
</span></code></pre></div>
<p>核心是添加了</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nt">&lt;ip</span><span class="w"> </span><span class="na">family=</span><span class="s">&#39;ipv6&#39;</span><span class="w"> </span><span class="na">address=</span><span class="s">&#39;fdXX:XXXX:XXXX:NNNN::1&#39;</span><span class="w"> </span><span class="na">prefix=</span><span class="s">&#39;64&#39;</span><span class="nt">&gt;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w">  </span><span class="nt">&lt;dhcp&gt;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="nt">&lt;range</span><span class="w"> </span><span class="na">start=</span><span class="s">&#39;fdXX:XXXX:XXXX:NNNN::10&#39;</span><span class="w"> </span><span class="na">end=</span><span class="s">&#39;fdXX:XXXX:XXXX:NNNN::ff&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span><span class="nt">&lt;/dhcp&gt;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="nt">&lt;/ip&gt;</span>
</span></code></pre></div>
<ul>
<li>需要将 IP 地址中的 <code>X</code>、<code>N</code> 更改为随机的 16 进制字母</li>
<li><code>fdXX:XXXX:XXXX::</code> 属于 <code>fc00::/7</code> 地址段，是 unique local address (ULA)，可类比为 IPv4 中的局域网地址段</li>
<li><code>X</code> 构成 IPv6 中的 prefix 部分，<code>N</code> 构成 subnet ID 部分，一般没啥影响，随机一个地址即可</li>
</ul>
<p>配置文件修改完成后，使用如下指令重启这个虚拟网络：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>sudo<span class="w"> </span>virsh<span class="w"> </span>net-destory<span class="w"> </span>net_name
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>sudo<span class="w"> </span>virsh<span class="w"> </span>net-start<span class="w"> </span>net_name
</span></code></pre></div>
<p>现在进入 guest，输入 <code>ip -c addr</code>，应该能看到获取到的 IPv6 地址。现在，你可以使用 IPv6 协议进行：</p>
<ul>
<li>该网络下 guests 间通讯</li>
<li>host 与该网络的 guests 间通讯</li>
</ul>
<p>但 libvirt 默认关闭 IPv6 NAT，所以现在 guest 仍然无法使用 IPv6 协议访问 Internet。</p>
<h3 id="ipv6-nat">启用 IPv6 NAT</h3>
<p>虽然 IPv6 并不推荐使用 NAT，但也有些需要使用 IPv6 的场景，例如：</p>
<ul>
<li>Host 只能通过 IPv6 上网</li>
<li>你是中国大陆用户：<ul>
<li>IPv6 网络环境比 IPv4 网络环境更加纯净，网速更快、没有那么拥挤、网络审查较少……</li>
<li>网络运营商为你的 Host 提供的 IPv4 是局域网 IPv4，但为你提供公网 IPv6 地址，并且你希望能直接从互联网访问 guest</li>
</ul>
</li>
<li>你正在使用中国教育网（CERNET）：为了鼓励 IPv6 发展，大部分高校并不收取 IPv6 流量费用，你希望顺应国家政策使用 IPv6 <span class="heimu">狠狠地薅国家羊毛</span></li>
</ul>
<p>可更具下属教程开启 IPv6 NAT：</p>
<ul>
<li>
<p>在 Host 开启 IPv6 转发</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># sudo vim /etc/sysctl.conf</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="c1"># add this line</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>net.ipv6.conf.all.forwarding<span class="o">=</span><span class="m">1</span>
</span></code></pre></div>
</li>
<li>
<p>将 VNS 的配置修改为：</p>
<div class="language-xml highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nt">&lt;network&gt;</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>...other<span class="w"> </span>configurations...
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nt">&lt;forward</span><span class="w"> </span><span class="na">mode=</span><span class="s">&#39;nat&#39;</span><span class="nt">&gt;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span><span class="nt">&lt;nat</span><span class="w"> </span><span class="na">ipv6=</span><span class="s">&#39;yes&#39;</span><span class="nt">&gt;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">    </span><span class="nt">&lt;port</span><span class="w"> </span><span class="na">start=</span><span class="s">&#39;50000&#39;</span><span class="w"> </span><span class="na">end=</span><span class="s">&#39;65535&#39;</span><span class="nt">/&gt;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="nt">&lt;/nat&gt;</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="nt">&lt;/forward&gt;</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="nt">&lt;/network&gt;</span>
</span></code></pre></div>
</li>
</ul>
<p>现在你的 guest 能正常使用 IPv6 访问 Internet 了，但有个小瑕疵：</p>
<ul>
<li>如果 Linux 系统既有 IPv4 地址又有公网 IPv6 地址，系统优先使用 IPv6 进行通讯</li>
<li>但因为分配给 guests 的是 <code>fc00::/8</code> 的 UCL 地址，系统会优先使用 IPv4 进行通讯</li>
</ul>
<p>操作系统为什么这么做？</p>
<ul>
<li>
<p><a href="https://www.rfcreader.com/#rfc3484">RFC3484  Default Address Selection for IPv6</a> 定义了系统具有多个 IP 地址时如何选择的规则，默认偏好使用 IPv6 地址</p>
</li>
<li>
<p>几乎所有操作系统都遵循 RFC3484 的规则</p>
</li>
<li>
<p>因为 ULA 的<a href="https://en.wikipedia.org/wiki/Unique_local_address">混乱历史</a>，ULA 地址很长一段时间内不可能被路由到。按照 RFC3484 的规则，系统将尝试使用 ULA 地址发起请求，但因为 ULA 地址不被路由，这样的请求多半会因超时失败，然后系统再尝试使用更低优先级的 IPv4 地址发起连接</p>
</li>
<li>
<p>这样“超时-重试”的过程引入大量网络延迟，所以大部分操作系统将 ULA 地址优先级降低到 IPv4 地址以下</p>
</li>
</ul>
<p>为解决该问题，需要编辑 <code>/etc/gai.conf</code> 文件：</p>
<ul>
<li>
<p><code>sudo vim /etc/gai.conf</code></p>
</li>
<li>
<p>找到</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1">#label ::1/128       0</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="c1">#label ::/0          1</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="c1">#label 2002::/16     2</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="c1">#label ::/96         3</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="c1">#label ::ffff:0:0/96 4</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="c1">#label fec0::/10     5</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="c1">#label fc00::/7      6</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="c1">#label 2001:0::/32   7</span>
</span></code></pre></div>
</li>
<li>
<p>取消注释，并添加一行，使上述内容成为</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>label<span class="w"> </span>::1/128<span class="w">       </span><span class="m">0</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>label<span class="w"> </span>::/0<span class="w">          </span><span class="m">1</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>label<span class="w"> </span><span class="m">2002</span>::/16<span class="w">     </span><span class="m">2</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>label<span class="w"> </span>::/96<span class="w">         </span><span class="m">3</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>label<span class="w"> </span>::ffff:0:0/96<span class="w"> </span><span class="m">4</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>label<span class="w"> </span>fec0::/10<span class="w">     </span><span class="m">5</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>label<span class="w"> </span>fc00::/7<span class="w">      </span><span class="m">6</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>label<span class="w"> </span><span class="m">2001</span>:0::/32<span class="w">   </span><span class="m">7</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>label<span class="w"> </span>fd00::/8<span class="w"> </span><span class="m">1</span>
</span></code></pre></div>
</li>
<li>
<p>保存，退出，验证系统偏好：</p>
<p>在命令行运行</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>getent<span class="w"> </span>ahosts<span class="w"> </span>ident.me
</span></code></pre></div>
<p>系统会按照该指令列出的顺序建立连接。</p>
<p>如果是 IPv6 地址在前，说明系统偏好 IPv6，例如：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>2a01:4f8:c0c:bd0a::1 STREAM ident.me
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>2a01:4f8:c0c:bd0a::1 DGRAM
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>2a01:4f8:c0c:bd0a::1 RAW
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>49.12.234.183   STREAM
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>49.12.234.183   DGRAM
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>49.12.234.183   RAW
</span></code></pre></div>
<p>反之如果 IPv4 地址在前，说明系统偏好 IPv4，例如：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>49.12.234.183   STREAM ident.me
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>49.12.234.183   DGRAM
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>49.12.234.183   RAW
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>2a01:4f8:c0c:bd0a::1 STREAM
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>2a01:4f8:c0c:bd0a::1 DGRAM
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>2a01:4f8:c0c:bd0a::1 RAW
</span></code></pre></div>
</li>
</ul>
<p>上述修改背后的原理：</p>
<ul>
<li>
<p>RFC3484 Section 6 规定排序规则，与本例相关的是：</p>
<ul>
<li>Rule 5: Prefer matching label</li>
<li>Rule 6: Prefer higher precedence</li>
<li>且 Rule 5 优先级比 Rule 6 高</li>
</ul>
</li>
<li>
<p>考虑默认配置：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>label<span class="w"> </span>::1/128<span class="w">       </span><span class="m">0</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>label<span class="w"> </span>::/0<span class="w">          </span><span class="m">1</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>label<span class="w"> </span><span class="m">2002</span>::/16<span class="w">     </span><span class="m">2</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>label<span class="w"> </span>::/96<span class="w">         </span><span class="m">3</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>label<span class="w"> </span>::ffff:0:0/96<span class="w"> </span><span class="m">4</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>label<span class="w"> </span>fec0::/10<span class="w">     </span><span class="m">5</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>label<span class="w"> </span>fc00::/7<span class="w">      </span><span class="m">6</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>label<span class="w"> </span><span class="m">2001</span>:0::/32<span class="w">   </span><span class="m">7</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a>precedence<span class="w">  </span>::1/128<span class="w">       </span><span class="m">50</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a>precedence<span class="w">  </span>::/0<span class="w">          </span><span class="m">40</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>precedence<span class="w">  </span><span class="m">2002</span>::/16<span class="w">     </span><span class="m">30</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a>precedence<span class="w"> </span>::/96<span class="w">          </span><span class="m">20</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a>precedence<span class="w"> </span>::ffff:0:0/96<span class="w">  </span><span class="m">10</span>
</span></code></pre></div>
<p><code>ident.me</code> 的地址</p>
<ul>
<li>IPv6 为 <code>2a01:4f8:c0c:bd0a::1</code> 匹配到 label 1</li>
<li>IPv4 为 <code>49.12.234.183</code> 匹配到 label 4</li>
</ul>
<p>本机的地址：</p>
<ul>
<li>IPv6 为 <code>fd12:8848:a2a2:1::74</code> 匹配到 label 6 
    (注意是最长前缀匹配，不是按照列表先后顺序匹配)</li>
<li>IPv4 为 <code>192.168.122.154</code> 匹配到 label 4</li>
</ul>
<p>按照 Rule 5，<code>ident.me</code> 和本机 <code>192.168.122.154</code> 的 label 相同，被优选选择，所以使用 IPv4 地址建立连接。</p>
</li>
<li>
<p>添加 <code>label fd00::/8 1</code> 一行后，<code>fd12:8848:a2a2:1::74</code> 被匹配到 label 1。</p>
<ul>
<li>IPv4 和 IPv6 的本机 label 和目标 label 相同，Rule 5 不能排出顺序</li>
<li>考虑 Rule 6，IPv6 优先级为 40、IPv4 优先级为 10，所以选择 IPv6 建立连接</li>
</ul>
</li>
</ul>
<h3 id="ipv6-dnat">配置 IPv6 DNAT</h3>
<p><del>与 IPv4 不同，IPv6 暂时没有现成的 DNAT 自动配置脚本。</del> 管理员可通过如下指令配置 DNAT：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nv">GUEST_IP</span><span class="o">=</span>xxxxxxxx
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="nv">GUEST_PORT</span><span class="o">=</span><span class="m">22</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="nv">VNS_DEV</span><span class="o">=</span>virbr0
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="nv">HOST_PORT</span><span class="o">=</span><span class="m">4023</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>sudo<span class="w"> </span>ip6tables<span class="w"> </span>-I<span class="w"> </span>FORWARD<span class="w"> </span>-o<span class="w"> </span><span class="nv">$VNS_DEV</span><span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>-d<span class="w"> </span><span class="nv">$GUEST_IP</span><span class="w"> </span>--dport<span class="w"> </span><span class="nv">$GUEST_PORT</span><span class="w"> </span>-j<span class="w"> </span>ACCEPT
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>sudo<span class="w"> </span>ip6tables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-I<span class="w"> </span>PREROUTING<span class="w"> </span>-p<span class="w"> </span>tcp<span class="w"> </span>--dport<span class="w"> </span><span class="nv">$HOST_PORT</span><span class="w"> </span>-j<span class="w"> </span>DNAT<span class="w"> </span>--to<span class="w"> </span><span class="s2">&quot;[</span><span class="nv">$GUEST_IP</span><span class="s2">]:</span><span class="nv">$GUEST_PORT</span><span class="s2">&quot;</span>
</span></code></pre></div>
<p>如果需要自动配置，可以考虑使用该仓库：<a href="https://github.com/GJCav/libvirt-hook-qemu">GJCav/libvirt-hook-qemu</a></p>
<p>该仓库从 <a href="https://github.com/saschpe/libvirt-hook-qemu">saschpe/libvirt-hook-qemu</a> fork 出，添加了对 IPv6 的支持，在作者的电脑上工作良好，已经向原作者提出 PR，正在等待审核</p>
<h2 id="_3">其他内容</h2>
<p>等待施工....</p>







  
  



  





  <h2 id="__comments">Comments</h2>
  <!-- Insert generated snippet here -->
  <script src="https://giscus.app/client.js"
        data-repo="gjcav/blog"
        data-repo-id="R_kgDOJ9MdDw"
        data-category="Comments"
        data-category-id="DIC_kwDOJ9MdD84CX-4C"
        data-mapping="pathname"
        data-strict="1"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
  </script>

  <!-- Synchronize Giscus theme with palette -->
  <script>
    var giscus = document.querySelector("script[src*=giscus]")

    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate" ? "dark" : "light"
      giscus.setAttribute("data-theme", theme) 
    }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>

                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../remote-management/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 远程管理">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                远程管理
              </div>
            </div>
          </a>
        
        
          
          <a href="../win-perf/" class="md-footer__link md-footer__link--next" aria-label="Next: Win on KVM 性能测试">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Win on KVM 性能测试
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Copyright and theme information -->
<div class="md-copyright">
    
      <div class="md-copyright__highlight">
        Copyright &copy; 2023 GJCav
      under 
      <a href="https://www.gnu.org/licenses/gpl-3.0.en.html#license-text" target="_blank">GNU GPLv3</a>
      </div>
    

    
      Made with
      <a
        href="https://squidfunk.github.io/mkdocs-material/"
        target="_blank" rel="noopener"
      >
        Material for MkDocs
      </a>
      and 
      <a
        href="https://gjcav.github.io/mkdocs-template/"
        target="_blank" ref="noopener"
      >
        GJCav Template
      </a>
    
  </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
      <div class="md-consent" data-md-component="consent" id="__consent" hidden>
        <div class="md-consent__overlay"></div>
        <aside class="md-consent__inner">
          <form class="md-consent__form md-grid md-typeset" name="consent">
            

  
    
  


  
    
  



  


<h4>Cookie consent</h4>
<p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p>
<input class="md-toggle" type="checkbox" id="__settings" >
<div class="md-consent__settings">
  <ul class="task-list">
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="analytics" checked>
          <span class="task-list-indicator"></span>
          Google Analytics
        </label>
      </li>
    
      
      
        
        
      
      <li class="task-list-item">
        <label class="task-list-control">
          <input type="checkbox" name="github" checked>
          <span class="task-list-indicator"></span>
          GitHub
        </label>
      </li>
    
  </ul>
</div>
<div class="md-consent__controls">
  
    
      <button class="md-button md-button--primary">Accept</button>
    
    
    
  
    
    
    
      <label class="md-button" for="__settings">Manage settings</label>
    
  
</div>
          </form>
        </aside>
      </div>
      <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout(function(){document.querySelector("[data-md-component=consent]").hidden=!1},250);var action,form=document.forms.consent;for(action of["submit","reset"])form.addEventListener(action,function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map(function(e){return[e,!0]}))),location.hash="",location.reload()})</script>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tracking", "content.code.copy", "content.code.annotate", "navigation.footer"], "search": "../../../assets/javascripts/workers/search.c011b7c0.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.7389ff0e.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="../../../javascripts/anime.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  <script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>